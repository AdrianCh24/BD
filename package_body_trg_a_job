--body paczki trg_a_job 
create or replace package body trg_a_job
is
--procedura która aktualizuje magazyn po wstawieniu zamówienia wykorzystywana przez trigger
  procedure orders
  is
    type quan_rt is record(product number,
                        quan number);
    type kol_nt is table of quan_rt;
    nt_order kol_nt;
    v_order_id number;
  begin
    select max(order_id)
    into v_order_id
    from orders;

    select r.product_id, r.quantity * o.quantity
    bulk collect into nt_order
    from orders o
    join recipes r on o.menu_id = r.menu_id
    where o.order_id = v_order_id;

    for i in nt_order.first..nt_order.last
    loop
      update warehouse
      set quantity = quantity - nt_order(i).quan
      where product_id = nt_order(i).product;
    end loop;
  end orders;

--procedura mająca podliczyć utarg kelnerów z całego dnia wykorzystywana przez joba uruchamiającego się po zamknięciu restauracji
  procedure waiter_profit
  is
    type rt_profit is record (emp_id number,
                            profit number);
    type kol_nt is table of rt_profit;
    nt_profit kol_nt := kol_nt();
  begin
    select o.employee_id, sum(o.quantity * m.dish_price)
    bulk collect into nt_profit
    from orders o
    join menu m on o.menu_id = m.menu_id
    group by employee_id;
  
    for i in nt_profit.first..nt_profit.last
    loop
      insert into waiters(employee_id, date_work, profit)
      values (nt_profit(i).emp_id, sysdate, nt_profit(i).profit);
    end loop;
    tekst('Podliczono utarg kelnerów i zapisano go do tabeli');
    --delete from orders;
  end waiter_profit;
  
end;
