--trigger wstawiający rekord do tabeli warehouse jeśli nie ma produktu o id jaki chcemy dodać

create or replace trigger bi_delivery_trg
before insert on delivery
for each row
declare
  v_count number;
begin
  select count(product_id)
  into v_count
  from warehouse
  where product_id = :new.product_id;

  if v_count = 0 then
    insert into warehouse(product_id, quantity, unit_code)
    values (:new.product_id, 0, :new.unit_code);
  end if;
end;

--trigger aktualizujący tabele warehouse jeśli dodamy dostawę
create or replace trigger ai_delivery_trg
after insert on delivery
for each row
declare
  v_quan number;
begin
  select quantity
  into v_quan
  from warehouse
  where product_id = :new.product_id;
  
  v_quan := :new.quantity + v_quan;
  
  update warehouse
  set quantity = v_quan
  where product_id = :new.product_id;
  
  tekst('=============================');
  tekst('magazyn został zaktualizowany');
end;

--trigger aktualizujący tabele warehouse jeśli dodamy zamówienie
create or replace trigger bi_orders_trg
before insert on orders
for each row
declare
  type quan_rt is record(product number,
                        quan number);
  type kol_nt is table of quan_rt;
  nt_order kol_nt;
begin
  select r.product_id, r.quantity * o.quantity
  bulk collect into nt_order
  from orders o
  join recipes r on o.menu_id = r.menu_id
  where o.menu_id = :new.menu_id;

  for i in nt_order.first..nt_order.last
  loop
    update warehouse
    set quantity = quantity - nt_order(i).quan
    where product_id = nt_order(i).product;
  end loop;
end;
